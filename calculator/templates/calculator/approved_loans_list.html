{# calculator/templates/calculator/approved_loans_list.html #}
{% extends 'calculator/base.html' %}
{% load static %}

{% block content %}
<div class="p-8 bg-white rounded-3xl shadow-2xl border border-slate-200 text-slate-900">
    <h2 class="text-3xl font-extrabold text-slate-900 border-b-2 border-indigo-400 pb-4 mb-6 text-center">Approved Loans Dashboard</h2>

    {# --- CRITICAL FIX: The form now wraps the entire table and buttons --- #}
    <form id="deleteForm" method="post" action="{% url 'delete_approved_loans' %}" onsubmit="return confirm('Are you sure you want to delete the selected loans? This action cannot be undone.');">
        {% csrf_token %}

        <div class="flex justify-between items-center mb-6">
            <a href="{% url 'export_approved_loans_csv' %}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 ease-in-out">
                <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L9 9.586V4a1 1 0 011-1z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                Export to CSV
            </a>

            {# The Delete Selected button is now INSIDE this form #}
            <button type="submit" name="delete_action" value="delete_selected" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 ease-in-out">
                <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                Delete Selected
            </button>
        </div>

        {% if loans %}
        <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-lg">
            <table class="min-w-full divide-y divide-slate-300">
                <thead class="bg-indigo-600">
                    <tr>
                        {# Checkbox Header #}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-xl">
                            <input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4 text-white bg-indigo-700 border-indigo-700 rounded focus:ring-indigo-500 cursor-pointer">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            S/N
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Account Number
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Name of Member
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Loan Amount (XAF)
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Duration (Years)
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">
                            Savings Balance (XAF)
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-xl">
                            Monthly Installment (XAF)
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {% for loan in loans %}
                    <tr class="hover:bg-slate-50 transition-colors duration-150">
                        {# Checkbox for each loan (name="loan_ids" is crucial) #}
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <input type="checkbox" name="loan_ids" value="{{ loan.id }}" class="loan-checkbox form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 cursor-pointer">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">
                            {{ loan.s_n }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.account_number }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.applicant_name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.loan_amount }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.duration_years }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.savings_balance }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            {{ loan.monthly_installment }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center p-8 bg-blue-50/50 rounded-xl border border-blue-200 text-blue-800">
            <p class="text-lg font-medium">No approved loans found yet. Submit some applications!</p>
        </div>
        {% endif %}
    </form> {# --- END OF FORM --- #}
</div>

{# Optional: Add a link back to the loan selection page #}
<div class="mt-10 text-center">
    <a href="{% url 'loan_type_selection' %}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 ease-in-out">
        ‚Üê Back to Loan Selection
    </a>
</div>

{# JavaScript for "Select All" functionality (remains the same) #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const loanCheckboxes = document.querySelectorAll('.loan-checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            loanCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        loanCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked) {
                    selectAllCheckbox.checked = false;
                } else {
                    const allChecked = Array.from(loanCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
    });
</script>
{% endblock %}